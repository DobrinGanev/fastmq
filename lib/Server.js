module.exports=function(e){function t(r){if(n[r])return n[r].exports;var s=n[r]={i:r,l:!1,exports:{}};return e[r].call(s.exports,s,s.exports,t),s.l=!0,s.exports}var n={};return t.m=e,t.c=n,t.d=function(e,n,r){t.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:r})},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=14)}([function(e,t,n){"use strict";function r(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function s(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e){return null!==e&&void 0!==e&&"function"==typeof e[Symbol.iterator]}function o(e){for(var t in y)if(e===y[t])return t;return null}function u(e){var t=void 0;switch(e){case 1:t="raw";break;case 2:t="json";break;case 3:t="string";break;default:t=""}return t}function h(e){return!!y[e]}function f(e){return!!_[e]}function c(e,t){return"raw"===t?e:"json"===t?0===e.length?null:JSON.parse(e.toString("utf8")):e.toString("utf8")}var l=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),p=n(3),d=n(1).uuid,v=n(2),y={req:1,res:2,push:3,pull:4,pub:5,sub:6,ack:7},_={raw:1,json:2,str:3},g=function(){function e(t){if(i(this,e),"number"==typeof t)this._buf=Buffer.allocUnsafe(t);else{if(!Buffer.isBuffer(t))throw TypeError("BufferStream only accept number or Buffer type as argument");this._buf=t}this._offset=0,this._size=t.length}return l(e,[{key:"get",value:function(){return this._buf}},{key:"readUInt8",value:function(){var e=this._buf.readUInt8(this._offset);return this._offset+=1,e}},{key:"readUInt16BE",value:function(){var e=this._buf.readUInt16BE(this._offset);return this._offset+=2,e}},{key:"readUInt32BE",value:function(){var e=this._buf.readUInt32BE(this._offset);return this._offset+=4,e}},{key:"readUInt64BE",value:function(){var e=new p(this._buf,this._offset).toNumber();return this._offset+=8,e}},{key:"readString",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"utf8",n=this._buf.toString(t,this._offset,this._offset+e);return this._offset+=e,n}},{key:"readBuffer",value:function(e){var t=this._buf.slice(this._offset,this._offset+e);return this._offset+=e,t}},{key:"writeUInt8",value:function(e){this._offset=this._buf.writeUInt8(e,this._offset)}},{key:"writeUInt16BE",value:function(e){this._offset=this._buf.writeUInt16BE(e,this._offset)}},{key:"writeUInt32BE",value:function(e){this._offset=this._buf.writeUInt32BE(e,this._offset)}},{key:"writeUInt64BE",value:function(e){new p(e).copy(this._buf,this._offset),this._offset+=8}},{key:"writeString",value:function(e,t){void 0===t&&(t=e.length),this._offset+=this._buf.write(e,this._offset,t)}},{key:"writeBuffer",value:function(e,t,n){this._offset+=e.copy(this._buf,this._offset,t,n)}},{key:"readHeaderString",value:function(){var e=this.readUInt8();return this.readString(e)}},{key:"writeHeaderString",value:function(e,t){void 0===t&&(t=Buffer.byteLength(e)),this.writeUInt8(t),this.writeString(e,t)}},{key:"offset",get:function(){return this._offset},set:function(e){this._offset=e}}]),e}(),k=function(){function e(t,n,r,s){i(this,e),this.messageLength=r||0,this.headerLength=s||0,this.header={id:n||d()},this.payload=void 0,this.payloadBuf=void 0,t&&this.setType(t)}return l(e,[{key:"isRequest",value:function(){return"req"===this.header.type}},{key:"isResponse",value:function(){return"res"===this.header.type}},{key:"isPush",value:function(){return"push"===this.header.type}},{key:"isPull",value:function(){return"pull"===this.header.type}},{key:"isPublish",value:function(){return"pub"===this.header.type}},{key:"isSubscribe",value:function(){return"sub"===this.header.type}},{key:"isAck",value:function(){return"ack"===this.header.type}},{key:"getEventName",value:function(){return this.header.topic+"."+this.header.id}},{key:"setType",value:function(e){if(!h(e))throw new TypeError("Invalid message type: "+e);this.header.type=e}},{key:"setContentType",value:function(e){if(!f(e))throw new TypeError("Invalid message content type: "+e);this.header.contentType=e}},{key:"setPayload",value:function(e,t){t?this.header.contentType=t:t=this.header.contentType,this.payload=e}},{key:"setPayloadBuf",value:function(e){this.payloadBuf=e}},{key:"getBuffer",value:function(){var e=this._getHeaderBuffer();this.headerLength=e.length,this.messageLength=8+this.headerLength,!this.payloadBuf&&this.payload&&(this.payloadBuf=this._getPayloadBuffer()),this.payloadBuf&&(this.messageLength+=this.payloadBuf.length);var t=Buffer.allocUnsafe(this.messageLength);return t.writeUInt32BE(this.messageLength),t.writeUInt32BE(this.headerLength,4),e.copy(t,8),this.payloadBuf&&this.payloadBuf.copy(t,8+this.headerLength),t}},{key:"_getPayloadBuffer",value:function(){var e=this.payload,t=this.header.contentType,n=void 0;if(!f(t))throw new TypeError("Unknown payload content type: "+t);return"raw"===t?n=Buffer.isBuffer(e)?e:Buffer.from(e):"json"===t?n=Buffer.from(JSON.stringify(e),"utf8"):"string"===t&&(n=Buffer.from(e)),n}}]),e}(),w=function(e){function t(e,n,s){return i(this,t),r(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,"req",e,n,s))}return s(t,e),l(t,[{key:"createFromBuffer",value:function(e){var t=e.slice(8,8+this.headerLength),n=new g(t);return n.offset=9,this.header.contentType=u(n.readUInt8()),this.header.error=n.readUInt8(),this.header.topic=n.readHeaderString(),this.header.source=n.readHeaderString(),this.header.target=n.readHeaderString(),this.payloadBuf=e.slice(8+this.headerLength,this.messageLength),this.payload=c(this.payloadBuf,this.header.contentType),this}},{key:"_getHeaderBuffer",value:function(){var e=this.header,t=Buffer.byteLength(e.topic,"utf8"),n=Buffer.byteLength(e.source,"utf8"),r=Buffer.byteLength(e.target,"utf8"),s=14+t+n+r,i=Buffer.alloc(s),a=new g(i);return a.writeUInt64BE(e.id),a.writeUInt8(y[e.type]),a.writeUInt8(_[e.contentType]),a.writeUInt8(e.error||0),a.writeHeaderString(e.topic,t),a.writeHeaderString(e.source,n),a.writeHeaderString(e.target,r),a.get()}},{key:"setTopic",value:function(e){this.header.topic=e}},{key:"setSource",value:function(e){this.header.source=e}},{key:"setTarget",value:function(e){this.header.target=e}}]),t}(k),b=function(e){function t(e,n,s){i(this,t);var a=r(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,n,s));return a.header.type="res",a}return s(t,e),l(t,[{key:"isError",value:function(e){var t=v[e];return void 0!==t&&this.header.error===t}},{key:"setError",value:function(e){if("number"!=typeof e)throw new TypeError("Invalid message error code: "+e);this.header.error=e}}]),t}(w),m=function(e){function t(e,n,s){return i(this,t),r(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,"pub",e,n,s))}return s(t,e),l(t,[{key:"createFromBuffer",value:function(e){var t=e.slice(8,8+this.headerLength),n=new g(t);return n.offset=9,this.header.contentType=u(n.readUInt8()),this.header.topic=n.readHeaderString(),this.header.target=n.readHeaderString(),this.payloadBuf=e.slice(8+this.headerLength,this.messageLength),this}},{key:"_getHeaderBuffer",value:function(){var e=this.header,t=Buffer.byteLength(e.topic,"utf8"),n=Buffer.byteLength(e.target,"utf8"),r=12+t+n,s=Buffer.alloc(r),i=new g(s);return i.writeUInt64BE(e.id),i.writeUInt8(y[e.type]),i.writeUInt8(_[e.contentType]),i.writeHeaderString(e.topic,t),i.writeHeaderString(e.target,n),i.get()}},{key:"setTopic",value:function(e){this.header.topic=e}},{key:"setTarget",value:function(e){this.header.target=e}}]),t}(k),B=function(e){function t(e,n,s){return i(this,t),r(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,"sub",e,n,s))}return s(t,e),l(t,[{key:"createFromBuffer",value:function(e){var t=e.slice(8,8+this.headerLength),n=new g(t);return n.offset=9,this.header.contentType=u(n.readUInt8()),this.header.topic=n.readHeaderString(),this.payloadBuf=e.slice(8+this.headerLength,this.messageLength),this.payload=c(this.payloadBuf,this.header.contentType),this}},{key:"_getHeaderBuffer",value:function(){var e=this.header,t=Buffer.byteLength(e.topic,"utf8"),n=11+t,r=Buffer.alloc(n),s=new g(r);return s.writeUInt64BE(e.id),s.writeUInt8(y[e.type]),s.writeUInt8(_[e.contentType]),s.writeHeaderString(e.topic,t),s.get()}},{key:"setTopic",value:function(e){this.header.topic=e}}]),t}(k),E=function(e){function t(e,n,s){i(this,t);var a=r(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,"push",e,n,s));return a.payload=[],a.items=[],a}return s(t,e),l(t,[{key:"createFromBuffer",value:function(e){var t=e.slice(8,8+this.headerLength),n=new g(t);n.offset=9,this.header.contentType=u(n.readUInt8()),this.header.topic=n.readHeaderString(),this.header.target=n.readHeaderString(),this.header.itemCount=n.readUInt32BE();var r=e.slice(8+this.headerLength,this.messageLength);return this.items=this._splitPayloadToItems(r),this}},{key:"_splitPayloadToItems",value:function(e){for(var t=this.header.itemCount,n=e.length,r=new g(e),s=[],i=0;i<t;i++){var a=r.readUInt32BE();if(r.offset+a>n)throw new RangeError("Payload buffer is smaller than expected.");var o=r.readBuffer(a);s.push(o)}return s}},{key:"_parsePayloadBuffer",value:function(e,t){var n=this.header.itemCount,r=e.length,s=new g(e),i=[];if("raw"===t)for(var a=0;a<n;a++){var o=s.readUInt32BE();if(s.offset+o>r)throw new RangeError("Payload buffer is smaller than expected.");var u=s.readBuffer(o);i.push(u)}else if("json"===t){if(n<1||0===e.length)return[];for(var h=0;h<n;h++){var f=s.readUInt32BE();if(s.offset+f>r)throw new RangeError("Payload buffer is smaller than expected.");var c=s.readBuffer(f);i.push(JSON.parse(c.toString("utf8")))}}else for(var l=0;l<n;l++){var p=s.readUInt32BE();if(s.offset+p>r)throw new RangeError("Payload buffer is smaller than expected.");var d=s.readBuffer(p);i.push(d.toString("utf8"))}this.payload=i}},{key:"_getHeaderBuffer",value:function(){var e=this.header,t=Buffer.byteLength(e.topic,"utf8"),n=Buffer.byteLength(e.target,"utf8"),r=16+t+n,s=Buffer.alloc(r),i=new g(s);return i.writeUInt64BE(e.id),i.writeUInt8(y[e.type]),i.writeUInt8(_[e.contentType]),i.writeHeaderString(e.topic,t),i.writeHeaderString(e.target,n),i.writeUInt32BE(e.itemCount),i.get()}},{key:"_getPayloadBuffer",value:function(){var e=this.payload,t=this.header.contentType;if(!f(t))throw new TypeError("Unknown payload content type: "+t);if(!a(e))throw new TypeError("payload should be an iterable object.");if(e.length!==this.header.itemCount)throw new TypeError("payload length should be equal to itemCount.");var n=[];if("raw"===t)for(var r in e){var s=e[r],i=Buffer.isBuffer(s)?s:Buffer.from(s),o=Buffer.allocUnsafe(i.length+4);o.writeUInt32BE(i.length,0),i.copy(o,4),n.push(o)}else if("json"===t)for(var u in e){var h=e[u],c=Buffer.from(JSON.stringify(h),"utf8"),l=Buffer.allocUnsafe(c.length+4);l.writeUInt32BE(c.length,0),c.copy(l,4),n.push(l)}else if("string"===t)for(var p in e){var d=e[p],v=Buffer.from(d),y=Buffer.allocUnsafe(v.length+4);y.writeUInt32BE(v.length,0),v.copy(y,4),n.push(y)}return Buffer.concat(n)}},{key:"setTopic",value:function(e){this.header.topic=e}},{key:"setTarget",value:function(e){this.header.target=e}},{key:"setItemCount",value:function(e){this.header.itemCount=e}},{key:"setPayload",value:function(e,t){if(!a(e))throw new TypeError("payload should be an iterable object.");t?this.header.contentType=t:t=this.header.contentType,this.payload=e,this.header.itemCount=e.length}}]),t}(k),T=function(e){function t(e,n,s){return i(this,t),r(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,"pull",e,n,s))}return s(t,e),l(t,[{key:"createFromBuffer",value:function(e){var t=e.slice(8,8+this.headerLength),n=new g(t);n.offset=9,this.header.contentType=u(n.readUInt8()),this.header.topic=n.readHeaderString();var r=e.slice(8+this.headerLength,this.messageLength);return this.payload=c(r,this.header.contentType),this}},{key:"_getHeaderBuffer",value:function(){var e=this.header,t=Buffer.byteLength(e.topic,"utf8"),n=11+t,r=Buffer.alloc(n),s=new g(r);return s.writeUInt64BE(e.id),s.writeUInt8(y[e.type]),s.writeUInt8(_[e.contentType]),s.writeHeaderString(e.topic,t),s.get()}},{key:"setTopic",value:function(e){this.header.topic=e}}]),t}(k),I=function(e){function t(e,n,s){return i(this,t),r(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,"ack",e,n,s))}return s(t,e),l(t,[{key:"createFromBuffer",value:function(e){var t=e.slice(8,8+this.headerLength),n=new g(t);return n.offset=9,this.header.topic=n.readHeaderString(),this}},{key:"_getHeaderBuffer",value:function(){var e=this.header,t=Buffer.byteLength(e.topic,"utf8"),n=10+t,r=Buffer.alloc(n),s=new g(r);return s.writeUInt64BE(e.id),s.writeUInt8(y[e.type]),s.writeHeaderString(e.topic,t),s.get()}},{key:"setTopic",value:function(e){this.header.topic=e}}]),t}(k);t.create=function(e,t){if("req"===e)return new w(t);if("res"===e)return new b(t);if("push"===e)return new E(t);if("pull"===e)return new T(t);if("pub"===e)return new m(t);if("sub"===e)return new B(t);if("ack"===e)return new I(t);throw new TypeError("Message type:"+e+" is not valid.")},t.createFromBuffer=function(e){var t=e.readUInt32BE(0),n=e.readUInt32BE(4),r=new p(e,8).toNumber(),s=o(e.readUInt8(16,!0)),i=void 0;if("req"===s)i=new w(r,t,n);else if("res"===s)i=new b(r,t,n);else if("push"===s)i=new E(r,t,n);else if("pull"===s)i=new T(r,t,n);else if("pub"===s)i=new m(r,t,n);else if("sub"===s)i=new B(r,t,n);else{if("ack"!==s)throw new TypeError("Message type:"+s+" is not valid.");i=new I(r,t,n)}return i.createFromBuffer(e),i}},function(e,t,n){"use strict";function r(){var e=Date.now(),t=r.last||e;return r.last=e>t?a+e:a+t+1,r.last}var s=n(4),i=n(5);t.toNumber=function(e){return(e=Number(e))>=0&&e},t.getSocketPath=function(e){var t=s.resolve(i.tmpdir(),".fast.mq."+e);return"win32"===process.platform&&(t=t.replace(/^\//,""),t=t.replace(/\//g,"-"),t="\\\\.\\pipe\\"+t),t};var a=process&&process.pid?process.pid:0;t.uuid=r},function(e,t,n){"use strict";e.exports={REGISTER_FAIL:1,TARGET_CHANNEL_NONEXIST:2,TOPIC_NONEXIST:3}},function(e,t){e.exports=require("node-int64")},function(e,t){e.exports=require("path")},function(e,t){e.exports=require("os")},function(e,t){e.exports=require("eventemitter3")},function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var s=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),i=n(0),a=function(){function e(t,n){r(this,e),this._reqMsg=t,this.socket=n,this._msg=i.create("res",t.header.id);var s=t.header;this._msg.setTopic(s.topic),this._msg.setSource(s.target),this._msg.setTarget(s.source),this._msg.setContentType(s.contentType)}return s(e,[{key:"header",value:function(e){return void 0===e?this._msg.header:this._msg.header[e]}},{key:"setSource",value:function(e){this._msg.setSource(e)}},{key:"setTarget",value:function(e){this._msg.setTarget(e)}},{key:"setError",value:function(e){this._msg.setError(e)}},{key:"setContentType",value:function(e){this._msg.setContentType(e)}},{key:"send",value:function(e,t){t&&this._msg.setContentType(t),this._msg.setPayload(e),this.socket.write(this._msg.getBuffer())}}]),e}();e.exports=a},function(e,t){e.exports=require("util")},function(e,t){e.exports=require("net")},function(e,t){e.exports=require("bluebird")},function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function i(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),o=n(0),u=n(6),h=function(e){function t(){r(this,t);var e=s(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e._recvBytes=0,e._expectMsgSize=0,e._recvBuf=null,e}return i(t,e),a(t,[{key:"recv",value:function(e,t){var n=e.length,r=0;try{for(;n>0;){if(0===this._recvBytes){this._expectMsgSize=e.readUInt32BE(r),this._recvBuf=Buffer.allocUnsafe(this._expectMsgSize);var s=n>this._expectMsgSize?this._expectMsgSize:n;e.copy(this._recvBuf,0,r,r+s),this._recvBytes+=s,r+=s,n-=s}else if(this._recvBytes<this._expectMsgSize){var i=this._expectMsgSize-this._recvBytes,a=n>i?i:n;e.copy(this._recvBuf,this._recvBytes,r,r+a),this._recvBytes+=a,r+=a,n-=a}if(this._recvBytes>=this._expectMsgSize){this._recvBytes-=this._expectMsgSize,this._expectMsgSize=0;var u=o.createFromBuffer(this._recvBuf);this.emit("message",u,this._recvBuf,t)}}}catch(e){this.emit("error",e)}}}]),t}(u);e.exports=h},function(e,t){e.exports=require("glob-to-regexp")},,function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var s=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),i=n(9),a=n(15),o=n(10),u=n(6),h=n(12),f=n(16),c=n(0),l=n(7),p=n(11),d=n(18),v=n(2),y=n(1),_=y.getSocketPath,g=y.toNumber,k=n(8),w=k.debuglog("fastmq"),b=function(){function e(t){r(this,e),this.channel=t.name,void 0===t.port?this._serverOptions={path:_(t.name),exclusive:!1}:this._serverOptions={port:t.port,host:t.host,exclusive:!1},this._server=null,this._sockets=[],this._channels=new d,this._queues=new f,this._msgReceiver=new p,this._requestHandlers={},this._requestEvent=new u,this._responseEvent=new u,this._handleConnection=this._handleConnection.bind(this),this._handleServerError=this._handleServerError.bind(this),this._channels.register(this.channel,null)}return s(e,[{key:"_prepareListeners",value:function(){var e=this;this._server.on("listening",function(){}),this._server.on("connection",this._handleConnection),this._server.on("error",this._handleServerError),this._msgReceiver.on("error",function(e){w("Message Receiver error:",e.stack)}),this._msgReceiver.on("message",function(t,n,r){var s=t.header;if(t.isRequest()){if(s.target!==e.channel)e._forwardRequestMessage(t,n,r);else if(!e._processInternalRequest(t,r)){var i=new l(t,r),a=e._channels.findResponseTopic(e.channel,t.header.topic);a?e._requestEvent.emit(s.topic,t,i):(i.setError(v.TOPIC_NONEXIST),i.send("","json"))}}else if(t.isResponse())s.target!==e.channel?e._forwardResponseMessage(t,n):e._responseEvent.emit(t.getEventName(),t);else if(t.isPush()){for(var o=e._queues.get("pull",s.topic),u=s.itemCount,f=h(s.target),c=0;c<u;c++)o.enqueue(t.items[c],f,s.contentType);o.process()}else if(t.isPublish()){var p=e._queues.get("sub",s.topic),d=h(s.target);p.enqueue(t.payloadBuf,d,s.contentType),p.process()}else t.isAck()&&e._queues.handleAck(t)})}},{key:"_setupRequestHandlers",value:function(){var e=this;this._requestHandlers.register=function(t,n){var r=t.header.source,s=n.socket;e._channels.has(r)?(w("Channel '"+r+"' already exist."),n.setError(v.REGISTER_FAIL)):(e._channels.register(r,s),w("Register channel '"+r+"'")),n.send("","json")},this._requestHandlers.addResponseListener=function(t,n){var r=t.header.source,s=e._channels.addResponse(r,t.payload.topic);s||n.setError(v.REGISTER_FAIL),n.send({result:!!s},"json")},this._requestHandlers.addPullListener=function(t,n){var r=t.payload,s=t.header.source,i=e._channels.addPull(s,r.topic,r.options);i||n.setError(v.REGISTER_FAIL),e._queues.get("pull",r.topic).addChannel(i),n.send({result:!!i},"json")},this._requestHandlers.addSubscribeListener=function(t,n){var r=t.payload,s=t.header.source,i=e._channels.addSubscribe(s,r.topic,r.options);i||n.setError(v.REGISTER_FAIL),e._queues.get("sub",r.topic).addChannel(i),n.send({result:!!i},"json")}}},{key:"start",value:function(){var e=this;return this._server||(this._server=i.createServer(),this._prepareListeners(),this._setupRequestHandlers()),new o(function(t,n){e._server.listen(e._serverOptions,function(){t(e)})})}},{key:"stop",value:function(){var e=this;return new o(function(t,n){e._shutdown(),e._server.close(function(){t(e)})})}},{key:"request",value:function(e,t){var n=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"json";return new o(function(i,a){if(!n._channels.contains(e))return a(new Error("Target channel["+e+"] doesn't exist."));try{var o=c.create("req");o.setTopic(t),o.setSource(n.channel),o.setTarget(e),o.setContentType(s),o.setPayload(r);var u=o.getBuffer();n._client.write(u),n._responseEvent.once(o.getEventName(),function(e){i(e)})}catch(e){a(e)}})}},{key:"response",value:function(e,t){return this._channels.addResponse(this.channel,e),this._requestEvent.on(e,function(e,n){t(e,n)}),this}},{key:"_forwardRequestMessage",value:function(e,t,n){var r=this._channels.findResponseTopic(e.header.target,e.header.topic);if(!r){var s=new l(e,n);return s.setSource(this.channel),s.setError(v.TARGET_CHANNEL_NONEXIST),void s.send("","json")}r.socket.write(t)}},{key:"_forwardResponseMessage",value:function(e,t){var n=e.header.target,r=this._channels.get(n);if(!r)return void w("The target channel '"+n+"' of Response message does not exist.");r.socket.write(t)}},{key:"_processInternalRequest",value:function(e,t){var n=e.header,r=n.topic;if(this._requestHandlers.hasOwnProperty(r)){var s=new l(e,t);return this._requestHandlers[r].call(this,e,s),!0}return!1}},{key:"_handleConnection",value:function(e){var t=this;this._sockets.push(e),e.on("data",function(n){t._msgReceiver.recv(n,e)}),e.on("error",function(t){e.unref()}),e.on("close",function(){var n=t._sockets.indexOf(e);-1!==n&&t._sockets.splice(n,1);var r=t._channels.unregisterBySocket(e);r&&(t._queues.removeChannels(r),w("Un-register channel '"+r+"'"))})}},{key:"_shutdown",value:function(){this._sockets.forEach(function(e){e&&e.destroy&&e.destroy()}),this._sockets=[],this._channels.unregisterAll()}},{key:"_handleServerError",value:function(e){var t=this;"EADDRINUSE"===e.code?(this._serverOptions.path?(this._server.close(),a.unlinkSync(this._serverOptions.path)):this._server.close(),setTimeout(function(){t._server.listen(t._serverOptions)},300)):w("Message broker server got error:",error.stack)}}]),e}();t.create=function(){if(arguments.length<1)throw new Error("Invalid create argument, it needs at least one argument.");for(var e=new Array(arguments.length),t=0;t<arguments.length;t++)e[t]=arguments[t];var n={};if(null===e[0]||"string"!=typeof e[0])throw new TypeError("Invalid channel name, channel name must be a string type.");return n.name=e[0],arguments.length>1&&"number"==typeof e[1]&&!1!==g(e[1])&&(n.port=g(e[1]),arguments.length>2&&"string"==typeof e[2]&&(n.host=e[2])),"number"==typeof n.port&&void 0===n.host&&(n.host="localhost"),new b(n)}},function(e,t){e.exports=require("fs")},function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){return e.handlers.hasOwnProperty(t)?e.handlers[t]:null}function i(e,t,n){var r=h.create(e,t.id);return r.setContentType(t.contentType),r.setTopic(n),r.setPayloadBuf(t.data),r}var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),o=n(17),u=n(1).uuid,h=n(0),f=n(8),c=f.debuglog("fastmq"),l=function(){function e(t,n){r(this,e),this._type=t,this._topic=n,this._channels=[],this._taskQueue=new o(16),this._nonAckTasks={},this._channelIndex=0}return a(e,[{key:"addChannel",value:function(e){var t=this,n=s(e,this._topic);if(!n)return!1;var r=e.name;e.socket.on("close",function(){c("TaskQueue: socket.close, channel: "+r),"pull"===n.type&&t.redeliver(r),t.removeChannel(r)}),this._channels.push({name:r,socket:e.socket,type:n.type,prefetch:n.options.prefetch||1,availCount:n.options.prefetch||1}),this._taskQueue.isEmpty()||this.process()}},{key:"removeChannel",value:function(e){for(var t=this._channels.length,n=t-1;n>=0;n--){this._channels[n].name===e&&this._channels.splice(n,1)}this._channelIndex>=this._channels.length&&(this._channelIndex=0)}},{key:"enqueue",value:function(e,t,n){var r={id:u(),targetRegExp:t,contentType:n,data:e};this._taskQueue.enqueue(r)}},{key:"process",value:function(){"pull"===this._type?this._processPullMessages():"sub"===this._type&&this._processSubscribeMessages()}},{key:"redeliver",value:function(e){for(var t in this._nonAckTasks){var n=this._nonAckTasks[t];if(n.channel===e){var r={id:n.id,targetRegExp:n.targetRegExp,contentType:n.contentType,data:n.data};c("redeliver task:",r),this._taskQueue.enqueue(r),delete this._nonAckTasks[t]}}}},{key:"handleAck",value:function(e){var t=this._nonAckTasks;if(!t.hasOwnProperty(e))return!1;for(var n=t[e],r=this._channels.length,s=0;s<r;s++)if(this._channels[s].name===n.channel){this._channels[s].availCount++;break}return delete t[e],this.process(),!0}},{key:"_dropTask",value:function(){var e=this._taskQueue,t=e.peekFront();return!this._channelMatch(t.targetRegExp)&&(c("Drop task in queue:",t),e.dequeue(),!0)}},{key:"_processPullMessages",value:function(){for(var e=this._taskQueue,t=!1,n=0,r=e.length*(this._channels.length?2*this._channels.length:2);!e.isEmpty()&&this._channelAvailable("pull");){if(n++>=r){warn("Exceed max. loop trying count:"+r);break}if(!this._dropTask()){for(var s=this._channelIndex,a=this._channels[s],o=a.availCount,u=0;u<o&&!(t=e.isEmpty());u++){var h=e.dequeue(),f=i("pull",h,this._topic);a.socket.write(f.getBuffer()),a.availCount--;var c={id:h.id,targetRegExp:h.targetRegExp,contentType:h.contentType,channel:a.name,data:h.data};this._nonAckTasks[h.id]=c}t||this._nextChannel()}}}},{key:"_processSubscribeMessages",value:function(){var e=this._taskQueue;for(c("Process SUB messages, queue size: "+e.length);!e.isEmpty();){var t=e.dequeue(),n=this._getSubscribeChannels(t.targetRegExp),r=n.length;c("item target: "+t.targetRegExp.toString()+", subChannelLength: "+r);for(var s=i("sub",t,this._topic),a=0;a<r;a++){var o=n[a];c("socket write"),o.socket.write(s.getBuffer())}}}},{key:"_nextChannel",value:function(){var e=this._channelIndex;this._channelIndex=e+1<this._channels.length?e+1:0}},{key:"_channelMatch",value:function(e){for(var t=this._channels.length,n=!1,r=0;r<t;r++){var s=this._channels[r];if(e.test(s.name)){n=!0;break}}return n}},{key:"_channelAvailable",value:function(e){for(var t=this._channels.length,n=!1,r=0;r<t;r++){var s=this._channels[r];if(s.type===e&&s.availCount>0){n=!0;break}}return n}},{key:"_getSubscribeChannels",value:function(e){for(var t=this._channels.length,n=[],r=0;r<t;r++){var s=this._channels[r];"subscribe"===s.type&&e.test(s.name)&&n.push(s)}return n}}]),e}(),p=function(){function e(){r(this,e),this._taskQueues={}}return a(e,[{key:"get",value:function(e,t){return this._taskQueues.hasOwnProperty(t)||(this._taskQueues[t]={}),this._taskQueues[t].hasOwnProperty(e)||(this._taskQueues[t][e]=new l(e,t)),this._taskQueues[t][e]}},{key:"removeTopic",value:function(e){this._taskQueues.hasOwnProperty(e)&&delete this._taskQueues[e]}},{key:"removeChannels",value:function(e){for(var t in this._taskQueues)for(var n in this._taskQueues[t])this._taskQueues[t][n].removeChannel(e)}},{key:"handleAck",value:function(e){var t=e.header;return!!this._taskQueues.hasOwnProperty(t.topic)&&(!!this._taskQueues[t.topic].hasOwnProperty("pull")&&this._taskQueues[t.topic].pull.handleAck(t.id))}}]),e}();e.exports=p},function(e,t){e.exports=require("double-ended-queue")},function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){return e=Math.ceil(e),t=Math.floor(t),Math.floor(Math.random()*(t-e+1))+e}var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),a=n(12),o=n(8),u=o.debuglog("fastmq"),h=function(){function e(){r(this,e),this._channels={}}return i(e,[{key:"has",value:function(e){return this._channels.hasOwnProperty(e)}},{key:"contains",value:function(e){var t=a(e);for(var n in this._channels)if(t.test(n))return!0;return!1}},{key:"register",value:function(e,t){this.has(e)&&delete this._channels[e],this._channels[e]={name:e,socket:t,handlers:{}}}},{key:"unregister",value:function(e){u("unregister channel name: "+e),delete this._channels[e]}},{key:"unregisterBySocket",value:function(e){var t=void 0;for(var n in this._channels)if(this._channels[n].socket===e){this.unregister(n),t=n;break}return t}},{key:"unregisterAll",value:function(){var e=this;Object.keys(this._channels).forEach(function(t){e.unregister(t)})}},{key:"addResponse",value:function(e,t,n){return this._add("response",e,t,n)}},{key:"addPull",value:function(e,t,n){return this._add("pull",e,t,n)}},{key:"addSubscribe",value:function(e,t,n){return this._add("subscribe",e,t,n)}},{key:"get",value:function(e){return this.has(e)?this._channels[e]:null}},{key:"find",value:function(e){var t=[],n=a(e);for(var r in this._channels)n.test(r)&&t.push(channel);return t}},{key:"findResponseTopic",value:function(e,t){var n=this._findTopic("response",e,t);return 0===n.length?null:1===n.length?n[0]:n[s(0,channles.length-1)]}},{key:"findPullTopic",value:function(e,t){return this._findTopic("pull",e,t)}},{key:"findSubscribeTopic",value:function(e,t){return this._findTopic("subscribe",e,t)}},{key:"_add",value:function(e,t,n,r){return!!this.has(t)&&(this._channels[t].handlers[n]={type:e,options:r||{}},this._channels[t])}},{key:"_findTopic",value:function(e,t,n){var r=[],s=a(t);for(var i in this._channels)if(s.test(i)||i===t){var o=this._channels[i],u=o.handlers;u.hasOwnProperty(n)&&u[n].type===e&&r.push(o)}return r}}]),e}();e.exports=h}]);