module.exports=function(e){function t(n){if(r[n])return r[n].exports;var i=r[n]={i:n,l:!1,exports:{}};return e[n].call(i.exports,i,i.exports,t),i.l=!0,i.exports}var r={};return t.m=e,t.c=r,t.d=function(e,r,n){t.o(e,r)||Object.defineProperty(e,r,{configurable:!1,enumerable:!0,get:n})},t.n=function(e){var r=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(r,"a",r),r},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=13)}([function(e,t,r){"use strict";function n(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function i(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e){return null!==e&&void 0!==e&&"function"==typeof e[Symbol.iterator]}function a(e){for(var t in v)if(e===v[t])return t;return null}function u(e){var t=void 0;switch(e){case 1:t="raw";break;case 2:t="json";break;case 3:t="string";break;default:t=""}return t}function f(e){return!!v[e]}function h(e){return!!g[e]}function c(e,t){return"raw"===t?e:"json"===t?0===e.length?null:JSON.parse(e.toString("utf8")):e.toString("utf8")}var l=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),p=r(3),d=r(1).uuid,y=r(2),v={req:1,res:2,push:3,pull:4,pub:5,sub:6,ack:7},g={raw:1,json:2,str:3},_=function(){function e(t){if(o(this,e),"number"==typeof t)this._buf=Buffer.allocUnsafe(t);else{if(!Buffer.isBuffer(t))throw TypeError("BufferStream only accept number or Buffer type as argument");this._buf=t}this._offset=0,this._size=t.length}return l(e,[{key:"get",value:function(){return this._buf}},{key:"readUInt8",value:function(){var e=this._buf.readUInt8(this._offset);return this._offset+=1,e}},{key:"readUInt16BE",value:function(){var e=this._buf.readUInt16BE(this._offset);return this._offset+=2,e}},{key:"readUInt32BE",value:function(){var e=this._buf.readUInt32BE(this._offset);return this._offset+=4,e}},{key:"readUInt64BE",value:function(){var e=new p(this._buf,this._offset).toNumber();return this._offset+=8,e}},{key:"readString",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"utf8",r=this._buf.toString(t,this._offset,this._offset+e);return this._offset+=e,r}},{key:"readBuffer",value:function(e){var t=this._buf.slice(this._offset,this._offset+e);return this._offset+=e,t}},{key:"writeUInt8",value:function(e){this._offset=this._buf.writeUInt8(e,this._offset)}},{key:"writeUInt16BE",value:function(e){this._offset=this._buf.writeUInt16BE(e,this._offset)}},{key:"writeUInt32BE",value:function(e){this._offset=this._buf.writeUInt32BE(e,this._offset)}},{key:"writeUInt64BE",value:function(e){new p(e).copy(this._buf,this._offset),this._offset+=8}},{key:"writeString",value:function(e,t){void 0===t&&(t=e.length),this._offset+=this._buf.write(e,this._offset,t)}},{key:"writeBuffer",value:function(e,t,r){this._offset+=e.copy(this._buf,this._offset,t,r)}},{key:"readHeaderString",value:function(){var e=this.readUInt8();return this.readString(e)}},{key:"writeHeaderString",value:function(e,t){void 0===t&&(t=Buffer.byteLength(e)),this.writeUInt8(t),this.writeString(e,t)}},{key:"offset",get:function(){return this._offset},set:function(e){this._offset=e}}]),e}(),w=function(){function e(t,r,n,i){o(this,e),this.messageLength=n||0,this.headerLength=i||0,this.header={id:r||d()},this.payload=void 0,this.payloadBuf=void 0,t&&this.setType(t)}return l(e,[{key:"isRequest",value:function(){return"req"===this.header.type}},{key:"isResponse",value:function(){return"res"===this.header.type}},{key:"isPush",value:function(){return"push"===this.header.type}},{key:"isPull",value:function(){return"pull"===this.header.type}},{key:"isPublish",value:function(){return"pub"===this.header.type}},{key:"isSubscribe",value:function(){return"sub"===this.header.type}},{key:"isAck",value:function(){return"ack"===this.header.type}},{key:"getEventName",value:function(){return this.header.topic+"."+this.header.id}},{key:"setType",value:function(e){if(!f(e))throw new TypeError("Invalid message type: "+e);this.header.type=e}},{key:"setContentType",value:function(e){if(!h(e))throw new TypeError("Invalid message content type: "+e);this.header.contentType=e}},{key:"setPayload",value:function(e,t){t?this.header.contentType=t:t=this.header.contentType,this.payload=e}},{key:"setPayloadBuf",value:function(e){this.payloadBuf=e}},{key:"getBuffer",value:function(){var e=this._getHeaderBuffer();this.headerLength=e.length,this.messageLength=8+this.headerLength,!this.payloadBuf&&this.payload&&(this.payloadBuf=this._getPayloadBuffer()),this.payloadBuf&&(this.messageLength+=this.payloadBuf.length);var t=Buffer.allocUnsafe(this.messageLength);return t.writeUInt32BE(this.messageLength),t.writeUInt32BE(this.headerLength,4),e.copy(t,8),this.payloadBuf&&this.payloadBuf.copy(t,8+this.headerLength),t}},{key:"_getPayloadBuffer",value:function(){var e=this.payload,t=this.header.contentType,r=void 0;if(!h(t))throw new TypeError("Unknown payload content type: "+t);return"raw"===t?r=Buffer.isBuffer(e)?e:Buffer.from(e):"json"===t?r=Buffer.from(JSON.stringify(e),"utf8"):"string"===t&&(r=Buffer.from(e)),r}}]),e}(),b=function(e){function t(e,r,i){return o(this,t),n(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,"req",e,r,i))}return i(t,e),l(t,[{key:"createFromBuffer",value:function(e){var t=e.slice(8,8+this.headerLength),r=new _(t);return r.offset=9,this.header.contentType=u(r.readUInt8()),this.header.error=r.readUInt8(),this.header.topic=r.readHeaderString(),this.header.source=r.readHeaderString(),this.header.target=r.readHeaderString(),this.payloadBuf=e.slice(8+this.headerLength,this.messageLength),this.payload=c(this.payloadBuf,this.header.contentType),this}},{key:"_getHeaderBuffer",value:function(){var e=this.header,t=Buffer.byteLength(e.topic,"utf8"),r=Buffer.byteLength(e.source,"utf8"),n=Buffer.byteLength(e.target,"utf8"),i=14+t+r+n,o=Buffer.alloc(i),s=new _(o);return s.writeUInt64BE(e.id),s.writeUInt8(v[e.type]),s.writeUInt8(g[e.contentType]),s.writeUInt8(e.error||0),s.writeHeaderString(e.topic,t),s.writeHeaderString(e.source,r),s.writeHeaderString(e.target,n),s.get()}},{key:"setTopic",value:function(e){this.header.topic=e}},{key:"setSource",value:function(e){this.header.source=e}},{key:"setTarget",value:function(e){this.header.target=e}}]),t}(w),m=function(e){function t(e,r,i){o(this,t);var s=n(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,r,i));return s.header.type="res",s}return i(t,e),l(t,[{key:"isError",value:function(e){var t=y[e];return void 0!==t&&this.header.error===t}},{key:"setError",value:function(e){if("number"!=typeof e)throw new TypeError("Invalid message error code: "+e);this.header.error=e}}]),t}(b),B=function(e){function t(e,r,i){return o(this,t),n(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,"pub",e,r,i))}return i(t,e),l(t,[{key:"createFromBuffer",value:function(e){var t=e.slice(8,8+this.headerLength),r=new _(t);return r.offset=9,this.header.contentType=u(r.readUInt8()),this.header.topic=r.readHeaderString(),this.header.target=r.readHeaderString(),this.payloadBuf=e.slice(8+this.headerLength,this.messageLength),this}},{key:"_getHeaderBuffer",value:function(){var e=this.header,t=Buffer.byteLength(e.topic,"utf8"),r=Buffer.byteLength(e.target,"utf8"),n=12+t+r,i=Buffer.alloc(n),o=new _(i);return o.writeUInt64BE(e.id),o.writeUInt8(v[e.type]),o.writeUInt8(g[e.contentType]),o.writeHeaderString(e.topic,t),o.writeHeaderString(e.target,r),o.get()}},{key:"setTopic",value:function(e){this.header.topic=e}},{key:"setTarget",value:function(e){this.header.target=e}}]),t}(w),k=function(e){function t(e,r,i){return o(this,t),n(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,"sub",e,r,i))}return i(t,e),l(t,[{key:"createFromBuffer",value:function(e){var t=e.slice(8,8+this.headerLength),r=new _(t);return r.offset=9,this.header.contentType=u(r.readUInt8()),this.header.topic=r.readHeaderString(),this.payloadBuf=e.slice(8+this.headerLength,this.messageLength),this.payload=c(this.payloadBuf,this.header.contentType),this}},{key:"_getHeaderBuffer",value:function(){var e=this.header,t=Buffer.byteLength(e.topic,"utf8"),r=11+t,n=Buffer.alloc(r),i=new _(n);return i.writeUInt64BE(e.id),i.writeUInt8(v[e.type]),i.writeUInt8(g[e.contentType]),i.writeHeaderString(e.topic,t),i.get()}},{key:"setTopic",value:function(e){this.header.topic=e}}]),t}(w),E=function(e){function t(e,r,i){o(this,t);var s=n(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,"push",e,r,i));return s.payload=[],s.items=[],s}return i(t,e),l(t,[{key:"createFromBuffer",value:function(e){var t=e.slice(8,8+this.headerLength),r=new _(t);r.offset=9,this.header.contentType=u(r.readUInt8()),this.header.topic=r.readHeaderString(),this.header.target=r.readHeaderString(),this.header.itemCount=r.readUInt32BE();var n=e.slice(8+this.headerLength,this.messageLength);return this.items=this._splitPayloadToItems(n),this}},{key:"_splitPayloadToItems",value:function(e){for(var t=this.header.itemCount,r=e.length,n=new _(e),i=[],o=0;o<t;o++){var s=n.readUInt32BE();if(n.offset+s>r)throw new RangeError("Payload buffer is smaller than expected.");var a=n.readBuffer(s);i.push(a)}return i}},{key:"_parsePayloadBuffer",value:function(e,t){var r=this.header.itemCount,n=e.length,i=new _(e),o=[];if("raw"===t)for(var s=0;s<r;s++){var a=i.readUInt32BE();if(i.offset+a>n)throw new RangeError("Payload buffer is smaller than expected.");var u=i.readBuffer(a);o.push(u)}else if("json"===t){if(r<1||0===e.length)return[];for(var f=0;f<r;f++){var h=i.readUInt32BE();if(i.offset+h>n)throw new RangeError("Payload buffer is smaller than expected.");var c=i.readBuffer(h);o.push(JSON.parse(c.toString("utf8")))}}else for(var l=0;l<r;l++){var p=i.readUInt32BE();if(i.offset+p>n)throw new RangeError("Payload buffer is smaller than expected.");var d=i.readBuffer(p);o.push(d.toString("utf8"))}this.payload=o}},{key:"_getHeaderBuffer",value:function(){var e=this.header,t=Buffer.byteLength(e.topic,"utf8"),r=Buffer.byteLength(e.target,"utf8"),n=16+t+r,i=Buffer.alloc(n),o=new _(i);return o.writeUInt64BE(e.id),o.writeUInt8(v[e.type]),o.writeUInt8(g[e.contentType]),o.writeHeaderString(e.topic,t),o.writeHeaderString(e.target,r),o.writeUInt32BE(e.itemCount),o.get()}},{key:"_getPayloadBuffer",value:function(){var e=this.payload,t=this.header.contentType;if(!h(t))throw new TypeError("Unknown payload content type: "+t);if(!s(e))throw new TypeError("payload should be an iterable object.");if(e.length!==this.header.itemCount)throw new TypeError("payload length should be equal to itemCount.");var r=[];if("raw"===t)for(var n in e){var i=e[n],o=Buffer.isBuffer(i)?i:Buffer.from(i),a=Buffer.allocUnsafe(o.length+4);a.writeUInt32BE(o.length,0),o.copy(a,4),r.push(a)}else if("json"===t)for(var u in e){var f=e[u],c=Buffer.from(JSON.stringify(f),"utf8"),l=Buffer.allocUnsafe(c.length+4);l.writeUInt32BE(c.length,0),c.copy(l,4),r.push(l)}else if("string"===t)for(var p in e){var d=e[p],y=Buffer.from(d),v=Buffer.allocUnsafe(y.length+4);v.writeUInt32BE(y.length,0),y.copy(v,4),r.push(v)}return Buffer.concat(r)}},{key:"setTopic",value:function(e){this.header.topic=e}},{key:"setTarget",value:function(e){this.header.target=e}},{key:"setItemCount",value:function(e){this.header.itemCount=e}},{key:"setPayload",value:function(e,t){if(!s(e))throw new TypeError("payload should be an iterable object.");t?this.header.contentType=t:t=this.header.contentType,this.payload=e,this.header.itemCount=e.length}}]),t}(w),T=function(e){function t(e,r,i){return o(this,t),n(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,"pull",e,r,i))}return i(t,e),l(t,[{key:"createFromBuffer",value:function(e){var t=e.slice(8,8+this.headerLength),r=new _(t);r.offset=9,this.header.contentType=u(r.readUInt8()),this.header.topic=r.readHeaderString();var n=e.slice(8+this.headerLength,this.messageLength);return this.payload=c(n,this.header.contentType),this}},{key:"_getHeaderBuffer",value:function(){var e=this.header,t=Buffer.byteLength(e.topic,"utf8"),r=11+t,n=Buffer.alloc(r),i=new _(n);return i.writeUInt64BE(e.id),i.writeUInt8(v[e.type]),i.writeUInt8(g[e.contentType]),i.writeHeaderString(e.topic,t),i.get()}},{key:"setTopic",value:function(e){this.header.topic=e}}]),t}(w),I=function(e){function t(e,r,i){return o(this,t),n(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,"ack",e,r,i))}return i(t,e),l(t,[{key:"createFromBuffer",value:function(e){var t=e.slice(8,8+this.headerLength),r=new _(t);return r.offset=9,this.header.topic=r.readHeaderString(),this}},{key:"_getHeaderBuffer",value:function(){var e=this.header,t=Buffer.byteLength(e.topic,"utf8"),r=10+t,n=Buffer.alloc(r),i=new _(n);return i.writeUInt64BE(e.id),i.writeUInt8(v[e.type]),i.writeHeaderString(e.topic,t),i.get()}},{key:"setTopic",value:function(e){this.header.topic=e}}]),t}(w);t.create=function(e,t){if("req"===e)return new b(t);if("res"===e)return new m(t);if("push"===e)return new E(t);if("pull"===e)return new T(t);if("pub"===e)return new B(t);if("sub"===e)return new k(t);if("ack"===e)return new I(t);throw new TypeError("Message type:"+e+" is not valid.")},t.createFromBuffer=function(e){var t=e.readUInt32BE(0),r=e.readUInt32BE(4),n=new p(e,8).toNumber(),i=a(e.readUInt8(16,!0)),o=void 0;if("req"===i)o=new b(n,t,r);else if("res"===i)o=new m(n,t,r);else if("push"===i)o=new E(n,t,r);else if("pull"===i)o=new T(n,t,r);else if("pub"===i)o=new B(n,t,r);else if("sub"===i)o=new k(n,t,r);else{if("ack"!==i)throw new TypeError("Message type:"+i+" is not valid.");o=new I(n,t,r)}return o.createFromBuffer(e),o}},function(e,t,r){"use strict";function n(){var e=Date.now(),t=n.last||e;return n.last=e>t?s+e:s+t+1,n.last}var i=r(4),o=r(5);t.toNumber=function(e){return(e=Number(e))>=0&&e},t.getSocketPath=function(e){var t=i.resolve(o.tmpdir(),".fast.mq."+e);return"win32"===process.platform&&(t=t.replace(/^\//,""),t=t.replace(/\//g,"-"),t="\\\\.\\pipe\\"+t),t};var s=process&&process.pid?process.pid:0;t.uuid=n},function(e,t,r){"use strict";e.exports={REGISTER_FAIL:1,TARGET_CHANNEL_NONEXIST:2,TOPIC_NONEXIST:3}},function(e,t){e.exports=require("node-int64")},function(e,t){e.exports=require("path")},function(e,t){e.exports=require("os")},function(e,t){e.exports=require("eventemitter3")},function(e,t,r){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var i=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(0),s=function(){function e(t,r){n(this,e),this._reqMsg=t,this.socket=r,this._msg=o.create("res",t.header.id);var i=t.header;this._msg.setTopic(i.topic),this._msg.setSource(i.target),this._msg.setTarget(i.source),this._msg.setContentType(i.contentType)}return i(e,[{key:"header",value:function(e){return void 0===e?this._msg.header:this._msg.header[e]}},{key:"setSource",value:function(e){this._msg.setSource(e)}},{key:"setTarget",value:function(e){this._msg.setTarget(e)}},{key:"setError",value:function(e){this._msg.setError(e)}},{key:"setContentType",value:function(e){this._msg.setContentType(e)}},{key:"send",value:function(e,t){t&&this._msg.setContentType(t),this._msg.setPayload(e),this.socket.write(this._msg.getBuffer())}}]),e}();e.exports=s},function(e,t){e.exports=require("util")},function(e,t){e.exports=require("net")},function(e,t){e.exports=require("bluebird")},function(e,t,r){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var s=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),a=r(0),u=r(6),f=function(e){function t(){n(this,t);var e=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e._recvBytes=0,e._expectMsgSize=0,e._recvBuf=null,e}return o(t,e),s(t,[{key:"recv",value:function(e,t){var r=e.length,n=0;try{for(;r>0;){if(0===this._recvBytes){this._expectMsgSize=e.readUInt32BE(n),this._recvBuf=Buffer.allocUnsafe(this._expectMsgSize);var i=r>this._expectMsgSize?this._expectMsgSize:r;e.copy(this._recvBuf,0,n,n+i),this._recvBytes+=i,n+=i,r-=i}else if(this._recvBytes<this._expectMsgSize){var o=this._expectMsgSize-this._recvBytes,s=r>o?o:r;e.copy(this._recvBuf,this._recvBytes,n,n+s),this._recvBytes+=s,n+=s,r-=s}if(this._recvBytes>=this._expectMsgSize){this._recvBytes-=this._expectMsgSize,this._expectMsgSize=0;var u=a.createFromBuffer(this._recvBuf);this.emit("message",u,this._recvBuf,t)}}}catch(e){this.emit("error",e)}}}]),t}(u);e.exports=f},,function(e,t,r){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){return e._serverRequest("register").then(function(t){if(t.header.error){var r=new Error("register channel fail.");return a.reject(r)}return a.resolve(e)})}var o=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),s=r(9),a=r(10),u=r(6),f=r(0),h=r(7),c=r(11),l=r(1).getSocketPath,p=r(8),d=p.debuglog("fastmq"),y=function(){function e(t,r,i){var o=this;n(this,e),this.channel=t,this.serverChannel=r,this._socket=i,this._requestEvent=new u,this._responseEvent=new u,this._subEvent=new u,this._pullEvent=new u,this._errorEvent=new u,this._msgReceiver=new c,this._msgReceiver.on("message",function(e,t,r){if(e.isRequest()){var n=new h(e,r);o._requestEvent.emit(e.header.topic,e,n)}else e.isResponse()?o._responseEvent.emit(e.getEventName(),e):e.isPull()?o._pullEvent.emit(e.header.topic,e):e.isSubscribe()&&o._subEvent.emit(e.header.topic,e)}),this._msgReceiver.on("error",function(e){d("Message receiver got error:",e.stack),o._errorEvent.emit("error",e)}),this._socket.on("data",function(e){o._msgReceiver.recv(e,o._socket)}),this._socket.on("error",function(e){o._errorEvent.emit("error",e)})}return o(e,[{key:"onError",value:function(e){if(void 0===e||"function"!=typeof e)throw new TypeError("Listener must be a function.");this._errorEvent.on("error",e)}},{key:"disconnect",value:function(){this._socket&&(this._socket.destroy(),this._socket.unref())}},{key:"request",value:function(e,t){var r=this,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"json";return new a(function(o,s){try{var a=f.create("req");a.setTopic(t),a.setSource(r.channel),a.setTarget(e),a.setContentType(i),a.setPayload(n);var u=a.getBuffer();r._socket.write(u),r._responseEvent.once(a.getEventName(),function(e){o(e)})}catch(e){s(e)}})}},{key:"_serverRequest",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"json";return this.request(this.serverChannel,e,t,r)}},{key:"response",value:function(e,t){var r=this;return this._requestEvent.on(e,function(e,r){t(e,r)}),this._serverRequest("addResponseListener",{topic:e},"json").then(function(t){d("addResponseListener topic: "+e+", result: "+t.payload.result),t.isError("REGISTER_FAIL")&&(r._requestEvent.removeAllListeners(e),r._errorEvent.emit("error",new Error("Register pull listener for topic: "+e+" fail")))}),this}},{key:"push",value:function(e,t,r){var n=this,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"json";return arguments.length<3?a.reject(new Error("Need at least three arguments.")):new a(function(o,s){var a=f.create("push");a.setTopic(t),a.setTarget(e),a.setPayload(r,i),n._socket.write(a.getBuffer(),"utf8",function(){o()})})}},{key:"pull",value:function(e,t,r){var n=this;if(arguments.length<2)return a.reject(new Error("Need at least two arguments."));var i=e,o=2===arguments.length?{prefetch:1}:t,s=2===arguments.length?t:r,u={topic:i,options:o};return this._pullEvent.on(i,function(e){a.resolve(s(e)).then(function(){n._sendAck(e.header.id,i)})}),this._serverRequest("addPullListener",u,"json").then(function(e){e.isError("REGISTER_FAIL")&&(n._pullEvent.removeAllListeners(i),n._errorEvent.emit("error",new Error("Register pull listener for topic: "+i+" fail")))}),this}},{key:"publish",value:function(e,t,r){var n=this,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"json";return arguments.length<3?a.reject(new Error("Need at least three arguments.")):new a(function(o,s){var a=f.create("pub");a.setTopic(t),a.setTarget(e),a.setPayload(r,i),n._socket.write(a.getBuffer(),"utf8",function(){o()})})}},{key:"subscribe",value:function(e,t){var r=this;if(arguments.length<2)return a.reject(new Error("Need at least two arguments."));var n={topic:e};return this._subEvent.on(e,function(e){t(e)}),this._serverRequest("addSubscribeListener",n,"json").then(function(t){t.isError("REGISTER_FAIL")&&(r._subEvent.removeAllListeners(e),r._errorEvent.emit("error",new Error("Register subscribe listener for topic: "+e+" fail")))}),this}},{key:"_sendAck",value:function(e,t){var r=f.create("ack",e);r.setTopic(t),this._socket.write(r.getBuffer())}}]),e}();t.connect=function(){if(arguments.length<2)throw new Error("Invalid create argument, it needs at least two argument.");for(var e=new Array(arguments.length),t=0;t<arguments.length;t++)e[t]=arguments[t];if(null===e[0]||"string"!=typeof e[0])throw new TypeError("Invalid client channel name, channel name must be a string type.");if(null===e[1]||"string"!=typeof e[1])throw new TypeError("Invalid server channel name, channel name must be a string type.");var r=e[0].trim(),n=e[1].trim(),o=e[e.length-1],u={};if(arguments.length>2&&"number"==typeof e[2]&&!1!==toNumber(e[2])?(u.port=toNumber(e[2]),arguments.length>3&&"string"==typeof e[3]&&(u.host=e[3]),void 0!==u.port&&void 0===u.host&&(u.host="localhost")):u.path=l(n),"function"==typeof o){var f=s.connect(u),h=new y(r,n,f);return f.on("connect",function(){i(h).then(function(){o(null,h)}).catch(function(e){o(e,h)})}),h}return new a(function(e,t){var o=s.connect(u,function(){return i(new y(r,n,o)).then(e).catch(t)})})}}]);